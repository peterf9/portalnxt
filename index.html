<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextStream - Portal do Integrador (NPP)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-50 font-sans text-slate-800">

    <header class="bg-slate-900 text-white p-6 shadow-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold border-l-4 border-green-500 pl-3">NextStream</h1>
                <p class="text-sm text-slate-400 mt-1">Alliance Partner Portal | <span class="text-green-400">Powered by IC²</span></p>
            </div>
            <div class="text-right">
                <p class="text-sm font-semibold">Deal Registration & TCV Tracking</p>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 mt-6">
        
        <div id="upload-section" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-8">
            <h2 class="text-lg font-bold mb-4 text-slate-700"><i class="fas fa-file-csv mr-2 text-blue-500"></i>Atualização de Dados (CSV)</h2>
            <p class="text-sm text-slate-500 mb-4">Carregue o arquivo "Plan - Integrador.xlsx - Plan.csv" para visualizar o dashboard de performance.</p>
            <input type="file" id="csvFileInput" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
        </div>

        <div id="dashboard" class="hidden">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 border-t-4 border-t-blue-500">
                    <h3 class="text-sm font-semibold text-slate-500 uppercase">Parceiro</h3>
                    <p id="partnerName" class="text-2xl font-bold mt-2">-</p>
                    <p id="partnerTier" class="text-sm text-blue-600 font-semibold mt-1">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 border-t-4 border-t-green-500">
                    <h3 class="text-sm font-semibold text-slate-500 uppercase">Total Rebates Acumulados</h3>
                    <p id="totalRebates" class="text-2xl font-bold text-green-600 mt-2">$0.00</p>
                    <p class="text-xs text-slate-400 mt-1">Impacto direto na margem operacional</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 border-t-4 border-t-teal-500">
                    <h3 class="text-sm font-semibold text-slate-500 uppercase">Impacto ESG (Serena Energia)</h3>
                    <p class="text-2xl font-bold text-teal-600 mt-2">100% Renovável</p>
                    <p class="text-xs text-slate-400 mt-1">Escopo 3 zerado nos projetos listados</p>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-slate-200">
                <div class="p-6 border-b border-slate-200 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-slate-800"><i class="fas fa-handshake mr-2 text-blue-500"></i>Projetos Especificados (Deal Registration)</h3>
                    <span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded">Proteção de Conta Ativa</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Cliente Final</th>
                                <th scope="col" class="px-6 py-3">Data</th>
                                <th scope="col" class="px-6 py-3">Valor (TCV Estimado)</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                complete: function(results) {
                    processCSVData(results.data);
                }
            });
        });

        function processCSVData(data) {
            // Lógica simples de varredura (Baseada na estrutura do arquivo 'Plan.csv' fornecido)
            let partnerName = "Não identificado";
            let partnerTier = "Não identificado";
            let totalRebates = "0";
            let projects = [];
            
            let isProjectSection = false;

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                // Extrair Nome do Canal e Classificação
                if (row[1] === "Nombre del canal") {
                    partnerName = row[3] || "Integrador Parceiro";
                    partnerTier = row[15] || "Tier Padrão"; 
                }

                // Extrair Total de Rebates
                if (row[17] === "Total rebates:") {
                    totalRebates = row[20] || "0";
                }

                // Detectar seção de Projetos Especificados (Deal Registration)
                if (row[1] === "Proyectos especificados y instalados") {
                    isProjectSection = true;
                    continue; // Pular o cabeçalho principal
                }

                if (isProjectSection) {
                    // Evitar ler linhas em branco ou seções subsequentes
                    if (row[1] === "Cliente final" || row[1] === "") {
                        if(row[1] === "" && row[2] === "") isProjectSection = false; // Fim da tabela
                        continue;
                    }
                    
                    // Se houver nome de cliente, registrar no array
                    if (row[1] && row[1].trim() !== "") {
                        projects.push({
                            cliente: row[1],
                            data: row[4] || "TBD",
                            valor: row[10] || "Sob consulta"
                        });
                    }
                }
            }

            // Atualizar UI
            document.getElementById('partnerName').innerText = partnerName;
            document.getElementById('partnerTier').innerText = partnerTier;
            document.getElementById('totalRebates').innerText = `$ ${parseFloat(totalRebates).toLocaleString('en-US')}`;

            // Preencher Tabela
            const tbody = document.getElementById('projectsTableBody');
            tbody.innerHTML = ''; // Limpar tabela
            
            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-slate-500">Nenhum projeto registrado neste ciclo.</td></tr>';
            } else {
                projects.forEach(p => {
                    tbody.innerHTML += `
                        <tr class="bg-white border-b hover:bg-slate-50">
                            <td class="px-6 py-4 font-medium text-slate-900">${p.cliente}</td>
                            <td class="px-6 py-4">${p.data}</td>
                            <td class="px-6 py-4 font-semibold text-blue-600">${p.valor}</td>
                        </tr>
                    `;
                });
            }

            // Mostrar Dashboard
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }
    </script>
</body>
</html>
