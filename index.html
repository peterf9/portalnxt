<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextStream - LATAM Partner Master Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body class="bg-slate-100 font-sans text-slate-800 pb-12">

    <script>
        const i18n = {
            pt: {
                title: "Master QBR Dashboard",
                subtitle: "Vis√£o 360¬∫: Estrat√©gia, Prospec√ß√£o, Receita e Capacita√ß√£o",
                exportBtn: "Exportar QBR",
                importBtn: "Importar CSV (QBR Anterior)",
                sec1Title: "1. Objetivos Conjuntos (Estrat√©gia)",
                sec2Title: "2. Clientes Target (Prospec√ß√£o)",
                sec3Title: "3. Pipeline Avan√ßado (Colocation + Servi√ßos)",
                sec4Title: "4. Passaporte NextStream (Treinamentos NPP)",
                partnerPh: "Nome do Integrador",
                amPh: "Account Manager NextStream",
                addBtn: "Adicionar",
                objDescPh: "Descri√ß√£o do Objetivo",
                objOwnerPh: "Respons√°vel",
                objObsPh: "Observa√ß√µes",
                tgtClientPh: "Cliente Alvo",
                tgtActionPh: "A√ß√£o Mapeada (Ex: Visita IC¬≤)",
                clientLbl: "Cliente Final",
                termLbl: "Contrato (Meses)",
                racksLbl: "Racks",
                kvaLbl: "kVA/Rack",
                setupLbl: "Setup (R$)",
                movLbl: "Moving (R$)",
                shLbl: "Incluir Smart Hands",
                dcLbl: "Data Centers do Projeto (M√∫ltipla Escolha)",
                tcvTotal: "TCV Total",
                comTotal: "Comiss√µes Projetadas",
                trnPersonPh: "Nome do Colaborador (Canal)"
            },
            es: {
                title: "Master QBR Dashboard",
                subtitle: "Visi√≥n 360¬∫: Estrategia, Prospecci√≥n, Ingresos y Capacitaci√≥n",
                exportBtn: "Exportar QBR",
                importBtn: "Importar CSV (QBR Anterior)",
                sec1Title: "1. Objetivos Conjuntos (Estrategia)",
                sec2Title: "2. Clientes Target (Prospecci√≥n)",
                sec3Title: "3. Pipeline Avanzado (Colocation + Servicios)",
                sec4Title: "4. Pasaporte NextStream (Entrenamientos NPP)",
                partnerPh: "Nombre del Integrador",
                amPh: "Account Manager NextStream",
                addBtn: "A√±adir",
                objDescPh: "Descripci√≥n del Objetivo",
                objOwnerPh: "Responsable",
                objObsPh: "Observaciones",
                tgtClientPh: "Cliente Objetivo",
                tgtActionPh: "Acci√≥n (Ej: Visita IC¬≤)",
                clientLbl: "Cliente Final",
                termLbl: "Contrato (Meses)",
                racksLbl: "Racks",
                kvaLbl: "kVA/Rack",
                setupLbl: "Setup ($)",
                movLbl: "Moving ($)",
                shLbl: "Incluir Smart Hands",
                dcLbl: "Data Centers del Proyecto (Selecci√≥n M√∫ltiple)",
                tcvTotal: "TCV Total",
                comTotal: "Comisiones Proyectadas",
                trnPersonPh: "Nombre del Colaborador (Canal)"
            },
            en: {
                title: "Master QBR Dashboard",
                subtitle: "360¬∫ View: Strategy, Target, Revenue & Enablement",
                exportBtn: "Export QBR",
                importBtn: "Import CSV (Previous QBR)",
                sec1Title: "1. Joint Objectives (Strategy)",
                sec2Title: "2. Target Clients (Go-to-Market)",
                sec3Title: "3. Advanced Pipeline (Colocation + Services)",
                sec4Title: "4. NextStream Passport (NPP Trainings)",
                partnerPh: "Partner Name",
                amPh: "NextStream Account Manager",
                addBtn: "Add",
                objDescPh: "Objective Description",
                objOwnerPh: "Owner",
                objObsPh: "Observations",
                tgtClientPh: "Target Client",
                tgtActionPh: "Action (E.g. IC¬≤ Visit)",
                clientLbl: "End Customer",
                termLbl: "Contract (Months)",
                racksLbl: "Racks",
                kvaLbl: "kVA/Rack",
                setupLbl: "Setup ($)",
                movLbl: "Moving ($)",
                shLbl: "Include Smart Hands",
                dcLbl: "Project Data Centers (Multi-Select)",
                tcvTotal: "Total TCV",
                comTotal: "Projected Commissions",
                trnPersonPh: "Employee Name (Partner)"
            }
        };
        let currentLang = 'pt';
    </script>

    <header class="bg-slate-900 text-white p-6 shadow-md border-b-4 border-green-500 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold">NextStream | <span class="text-blue-400 font-normal" data-i18n="title">Master QBR Dashboard</span></h1>
                <p class="text-sm text-slate-400 mt-1" data-i18n="subtitle">Vis√£o 360¬∫: Estrat√©gia, Prospec√ß√£o, Receita e Capacita√ß√£o</p>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="flex bg-slate-800 p-1 rounded-md border border-slate-700 shadow-inner">
                    <button id="btn-pt" onclick="changeLanguage('pt')" class="lang-btn px-3 py-1.5 rounded text-sm font-bold transition-all duration-200 bg-slate-600 text-white shadow">üáßüá∑ PT</button>
                    <button id="btn-es" onclick="changeLanguage('es')" class="lang-btn px-3 py-1.5 rounded text-sm font-medium transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-700">üá™üá∏ ES</button>
                    <button id="btn-en" onclick="changeLanguage('en')" class="lang-btn px-3 py-1.5 rounded text-sm font-medium transition-all duration-200 text-slate-400 hover:text-white hover:bg-slate-700">üá∫üá∏ EN</button>
                </div>

                <div class="flex space-x-2">
                    <label for="importCsv" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2.5 rounded-md text-sm font-bold shadow-md transition flex items-center cursor-pointer">
                        <i class="fas fa-file-import mr-2"></i><span data-i18n="importBtn">Importar CSV (QBR Anterior)</span>
                    </label>
                    <input type="file" id="importCsv" accept=".csv" class="hidden" onchange="importAllFromCSV(event)">

                    <button onclick="exportAllToCSV()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2.5 rounded-md text-sm font-bold shadow-md transition flex items-center">
                        <i class="fas fa-file-export mr-2"></i><span data-i18n="exportBtn">Exportar QBR</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 mt-4 space-y-6">
        <section class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="partnerInput" class="w-full rounded border-slate-300 p-2 border text-sm font-bold" data-i18n-ph="partnerPh" placeholder="Nome do Integrador">
                <input type="text" id="amInput" class="w-full rounded border-slate-300 p-2 border text-sm" data-i18n-ph="amPh" placeholder="Account Manager NextStream">
                <input type="date" id="qbrDate" class="w-full rounded border-slate-300 p-2 border text-sm">
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 border-l-4 border-l-purple-500">
            <h2 class="text-lg font-bold text-slate-800 mb-4"><i class="fas fa-bullseye text-purple-500 mr-2"></i><span data-i18n="sec1Title">1. Objetivos Conjuntos (Estrat√©gia)</span></h2>
            <form id="formObj" class="flex flex-wrap gap-2 mb-4">
                <input type="text" id="objDesc" required class="flex-1 rounded border-slate-300 p-2 border text-sm" data-i18n-ph="objDescPh" placeholder="Descri√ß√£o do Objetivo">
                <input type="date" id="objDate" required class="w-36 rounded border-slate-300 p-2 border text-sm">
                <input type="text" id="objOwner" required class="w-48 rounded border-slate-300 p-2 border text-sm" data-i18n-ph="objOwnerPh" placeholder="Respons√°vel">
                <input type="text" id="objObs" class="flex-1 rounded border-slate-300 p-2 border text-sm" data-i18n-ph="objObsPh" placeholder="Observa√ß√µes">
                <button type="submit" class="bg-purple-100 text-purple-700 px-4 py-2 rounded hover:bg-purple-200 transition"><i class="fas fa-plus"></i></button>
            </form>
            <table class="w-full text-sm text-left text-slate-500"><tbody id="tableObj"></tbody></table>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 border-l-4 border-l-blue-500">
            <h2 class="text-lg font-bold text-slate-800 mb-4"><i class="fas fa-crosshairs text-blue-500 mr-2"></i><span data-i18n="sec2Title">2. Clientes Target (Prospec√ß√£o)</span></h2>
            <form id="formTarget" class="flex flex-wrap gap-2 mb-4">
                <input type="text" id="targetName" required class="w-1/4 rounded border-slate-300 p-2 border text-sm" data-i18n-ph="tgtClientPh" placeholder="Cliente Alvo">
                <input type="text" id="targetAction" required class="flex-1 rounded border-slate-300 p-2 border text-sm" data-i18n-ph="tgtActionPh" placeholder="A√ß√£o Mapeada">
                <select id="targetStatus" class="w-36 rounded border-slate-300 p-2 border text-sm">
                    <option value="Mapeamento">Mapeamento</option>
                    <option value="Contato">Contato</option>
                    <option value="Visita IC2">Visita IC¬≤</option>
                </select>
                <input type="text" id="targetObs" class="flex-1 rounded border-slate-300 p-2 border text-sm" data-i18n-ph="objObsPh" placeholder="Observa√ß√µes">
                <button type="submit" class="bg-blue-100 text-blue-700 px-4 py-2 rounded hover:bg-blue-200 transition"><i class="fas fa-plus"></i></button>
            </form>
            <table class="w-full text-sm text-left text-slate-500"><tbody id="tableTarget"></tbody></table>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 border-l-4 border-l-orange-500">
            <h2 class="text-lg font-bold text-slate-800 mb-2"><i class="fas fa-server text-orange-500 mr-2"></i><span data-i18n="sec3Title">3. Pipeline Avan√ßado (Colocation + Servi√ßos)</span></h2>
            
            <form id="formProject" class="mb-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-xs font-semibold text-slate-600 mb-1" data-i18n="clientLbl">Cliente Final</label>
                        <input type="text" id="projClient" required class="w-full rounded border-slate-300 p-2 border text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1" data-i18n="termLbl">Contrato (Meses)</label>
                        <select id="projTerm" required class="w-full rounded border-slate-300 p-2 border text-sm font-bold text-blue-700">
                            <option value="24">24 (5%)</option>
                            <option value="36">36 (7%)</option>
                            <option value="48">48 (8.5%)</option>
                            <option value="60">60 (10%)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1" data-i18n="racksLbl">Racks</label>
                        <input type="number" id="projRacks" required min="1" class="w-full rounded border-slate-300 p-2 border text-sm" value="1">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1" data-i18n="kvaLbl">kVA/Rack</label>
                        <input type="number" id="projKva" required min="1" step="0.5" class="w-full rounded border-slate-300 p-2 border text-sm">
                    </div>
                </div>

                <div class="mt-4 border-t border-slate-200 pt-3">
                    <label class="block text-xs font-bold text-slate-700 mb-2" data-i18n="dcLbl">Data Centers do Projeto (M√∫ltipla Escolha)</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 text-xs text-slate-700">
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="Tambor√© (BR)" class="rounded text-blue-600 focus:ring-blue-500"> <span>Tambor√© (BR)</span></label>
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="Curitiba (BR)" class="rounded text-blue-600 focus:ring-blue-500"> <span>Curitiba (BR)</span></label>
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="Ixtlahuaca (MX)" class="rounded text-blue-600 focus:ring-blue-500"> <span>Ixtlahuaca (MX)</span></label>
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="Barracas (AR)" class="rounded text-blue-600 focus:ring-blue-500"> <span>Barracas (AR)</span></label>
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="Velez (AR)" class="rounded text-blue-600 focus:ring-blue-500"> <span>Velez (AR)</span></label>
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="Lince (PE)" class="rounded text-blue-600 focus:ring-blue-500"> <span>Lince (PE)</span></label>
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="Monterico (PE)" class="rounded text-blue-600 focus:ring-blue-500"> <span>Monterico (PE)</span></label>
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="Paine 1 (CL)" class="rounded text-blue-600 focus:ring-blue-500"> <span>Paine 1 (CL)</span></label>
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="Paine 2 (CL)" class="rounded text-blue-600 focus:ring-blue-500"> <span>Paine 2 (CL)</span></label>
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="Apoquindo (CL)" class="rounded text-blue-600 focus:ring-blue-500"> <span>Apoquindo (CL)</span></label>
                        <label class="flex items-center space-x-1 cursor-pointer hover:text-blue-600"><input type="checkbox" name="projDc" value="San Martin (CL)" class="rounded text-blue-600 focus:ring-blue-500"> <span>San Martin (CL)</span></label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-3 border-t border-slate-200 pt-3 mt-3 items-end">
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1" data-i18n="setupLbl">Setup</label>
                        <input type="number" id="projSetup" class="w-full rounded border-slate-300 p-2 border text-sm" placeholder="R$ 25k/rack padrao">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1" data-i18n="movLbl">Moving</label>
                        <input type="number" id="projMoving" class="w-full rounded border-slate-300 p-2 border text-sm">
                    </div>
                    <div class="pb-2">
                        <label class="flex items-center space-x-2 cursor-pointer bg-white p-2 border border-slate-300 rounded shadow-sm hover:bg-slate-50">
                            <input type="checkbox" id="projSmartHands" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                            <span class="text-xs font-bold text-slate-700" data-i18n="shLbl">Incluir Smart Hands</span>
                        </label>
                    </div>
                    <div>
                        <button type="submit" class="w-full bg-slate-900 text-white font-bold px-4 py-2 rounded hover:bg-slate-800 transition shadow-sm"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </form>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr><th class="p-3">Info</th><th class="p-3 text-right">TCV</th><th class="p-3 text-right">Comiss√£o</th><th class="p-3 text-center">X</th></tr>
                    </thead>
                    <tbody id="tableProject"></tbody>
                </table>
            </div>
            
            <div class="mt-4 p-4 bg-slate-50 border border-slate-200 rounded-lg flex justify-end space-x-8">
                <div class="text-right">
                    <p class="text-xs font-bold text-slate-500 uppercase" data-i18n="tcvTotal">TCV Total</p>
                    <p id="totalTcvView" class="text-2xl font-black text-slate-800">0.00</p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-bold text-slate-500 uppercase" data-i18n="comTotal">Comiss√µes Projetadas</p>
                    <p id="totalComView" class="text-2xl font-black text-green-600">0.00</p>
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 border-l-4 border-l-green-500">
            <h2 class="text-lg font-bold text-slate-800 mb-4"><i class="fas fa-graduation-cap text-green-500 mr-2"></i><span data-i18n="sec4Title">4. Passaporte NextStream (Treinamentos NPP)</span></h2>
            <form id="formTrain" class="flex flex-wrap gap-2 mb-4">
                <select id="trainName" class="w-1/4 rounded border-slate-300 p-2 border text-sm">
                    <option value="Comercial B√°sico">Comercial B√°sico</option>
                    <option value="Colocation Alta Densidade">Colocation Alta Densidade</option>
                    <option value="Visita IC2 / Serena">Visita Operacional IC¬≤</option>
                </select>
                <input type="text" id="trainPerson" required class="flex-1 rounded border-slate-300 p-2 border text-sm" data-i18n-ph="trnPersonPh" placeholder="Nome do Colaborador">
                <input type="date" id="trainDate" required class="w-36 rounded border-slate-300 p-2 border text-sm">
                <select id="trainStatus" class="w-36 rounded border-slate-300 p-2 border text-sm">
                    <option value="Agendado">Agendado</option>
                    <option value="Concluido">Conclu√≠do</option>
                </select>
                <button type="submit" class="bg-green-100 text-green-700 px-4 py-2 rounded hover:bg-green-200 transition"><i class="fas fa-plus"></i></button>
            </form>
            <table class="w-full text-sm text-left text-slate-500"><tbody id="tableTrain"></tbody></table>
        </section>
    </main>

    <script>
        // --- Motor i18n ---
        function changeLanguage(lang) {
            currentLang = lang;
            const dict = i18n[lang];
            
            document.querySelectorAll('[data-i18n]').forEach(el => { el.innerText = dict[el.getAttribute('data-i18n')]; });
            document.querySelectorAll('[data-i18n-ph]').forEach(el => { el.placeholder = dict[el.getAttribute('data-i18n-ph')]; });
            
            const btns = ['pt', 'es', 'en'];
            btns.forEach(b => {
                const btnEl = document.getElementById(`btn-${b}`);
                if(b === lang) {
                    btnEl.classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-slate-700', 'font-medium');
                    btnEl.classList.add('bg-slate-600', 'text-white', 'shadow', 'font-bold');
                } else {
                    btnEl.classList.remove('bg-slate-600', 'text-white', 'shadow', 'font-bold');
                    btnEl.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-slate-700', 'font-medium');
                }
            });
            renderProject(); 
        }
        
        document.addEventListener('DOMContentLoaded', () => { 
            changeLanguage('pt'); 
            document.getElementById('qbrDate').valueAsDate = new Date(); 
        });

        // --- Dados da Mem√≥ria ---
        let qbrData = { objetivos: [], targets: [], projetos: [], treinamentos: [] };
        const VALOR_KVA = 1100;

        function addRow(e, formId, dataArray, dataObj, renderFunc) {
            e.preventDefault(); dataArray.push(dataObj); document.getElementById(formId).reset(); renderFunc();
        }
        function removeRow(index, dataArray, renderFunc) {
            dataArray.splice(index, 1); renderFunc();
        }

        // Renderizadores
        document.getElementById('formObj').addEventListener('submit', (e) => {
            addRow(e, 'formObj', qbrData.objetivos, {
                desc: document.getElementById('objDesc').value, date: document.getElementById('objDate').value,
                owner: document.getElementById('objOwner').value, obs: document.getElementById('objObs').value
            }, renderObj);
        });
        function renderObj() {
            const tbody = document.getElementById('tableObj'); tbody.innerHTML = '';
            qbrData.objetivos.forEach((item, index) => {
                tbody.innerHTML += `<tr class="border-b"><td class="py-2 font-medium">${item.desc}</td><td class="py-2">${item.date}</td><td class="py-2"><span class="bg-slate-200 px-2 py-1 rounded text-xs">${item.owner}</span></td><td class="py-2">${item.obs}</td><td class="py-2"><button onclick="removeRow(${index}, qbrData.objetivos, renderObj)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        document.getElementById('formTarget').addEventListener('submit', (e) => {
            addRow(e, 'formTarget', qbrData.targets, {
                client: document.getElementById('targetName').value, action: document.getElementById('targetAction').value,
                status: document.getElementById('targetStatus').value, obs: document.getElementById('targetObs').value
            }, renderTarget);
        });
        function renderTarget() {
            const tbody = document.getElementById('tableTarget'); tbody.innerHTML = '';
            qbrData.targets.forEach((item, index) => {
                tbody.innerHTML += `<tr class="border-b"><td class="py-2 font-bold">${item.client}</td><td class="py-2">${item.action}</td><td class="py-2"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${item.status}</span></td><td class="py-2">${item.obs}</td><td class="py-2"><button onclick="removeRow(${index}, qbrData.targets, renderTarget)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        document.getElementById('formProject').addEventListener('submit', (e) => {
            e.preventDefault();
            const racks = parseInt(document.getElementById('projRacks').value) || 0;
            const kva = parseFloat(document.getElementById('projKva').value) || 0;
            const term = parseInt(document.getElementById('projTerm').value);
            const setupInput = document.getElementById('projSetup').value;
            const setup = setupInput !== "" ? parseFloat(setupInput) : (racks * 25000); 
            const moving = parseFloat(document.getElementById('projMoving').value) || 0;
            const strSmartHands = document.getElementById('projSmartHands').checked ? 'Sim' : 'N√£o';

            let selectedDCs = [];
            document.querySelectorAll('input[name="projDc"]:checked').forEach(cb => { selectedDCs.push(cb.value); });
            const dcs = selectedDCs.length > 0 ? selectedDCs.join(', ') : 'N√£o definido';

            const totalKva = racks * kva;
            const mrr = (totalKva * VALOR_KVA);
            const tcv = (mrr * term) + setup + moving;

            let comPerc = 0.05;
            if (term === 36) comPerc = 0.07;
            if (term === 48) comPerc = 0.085;
            if (term >= 60) comPerc = 0.10;

            qbrData.projetos.push({ client: document.getElementById('projClient').value, term, racks, kva, totalKva, setup, moving, smartHands: strSmartHands, dcs: dcs, tcv, comPerc: comPerc*100, comValor: tcv*comPerc });
            
            document.getElementById('formProject').reset();
            document.getElementById('projTerm').value = "24"; 
            document.getElementById('projRacks').value = "1";
            renderProject();
        });

        function renderProject() {
            const tbody = document.getElementById('tableProject'); tbody.innerHTML = '';
            let sumTcv = 0; let sumCom = 0;
            const curr = currentLang === 'en' ? '$' : (currentLang === 'es' ? '$' : 'R$');

            qbrData.projetos.forEach((item, index) => {
                sumTcv += item.tcv; sumCom += item.comValor;
                let badgeSH = item.smartHands === 'Sim' ? `<span class="bg-blue-100 text-blue-800 px-1 rounded font-bold">SH: Sim</span>` : `<span class="text-slate-400">SH: N√£o</span>`;

                tbody.innerHTML += `<tr class="border-b hover:bg-white transition">
                    <td class="p-3">
                        <span class="font-bold text-slate-900">${item.client}</span> 
                        <span class="ml-2 text-xs font-semibold text-orange-600"><i class="fas fa-map-marker-alt"></i> ${item.dcs}</span><br>
                        <span class="text-xs text-slate-500">${item.term}m | ${item.racks} Racks | ${item.totalKva} kVA | Set:${item.setup.toLocaleString()} | Mov:${item.moving.toLocaleString()} | ${badgeSH}</span>
                    </td>
                    <td class="p-3 text-right font-black text-slate-800">${item.tcv.toLocaleString('en-US', {minimumFractionDigits:2})}</td>
                    <td class="p-3 text-right"><span class="font-black text-green-600">${item.comValor.toLocaleString('en-US', {minimumFractionDigits:2})}</span> <span class="text-xs text-slate-400">(${item.comPerc}%)</span></td>
                    <td class="p-3 text-center"><button onclick="removeRow(${index}, qbrData.projetos, renderProject)" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
            document.getElementById('totalTcvView').innerText = `${curr} ${sumTcv.toLocaleString('en-US', {minimumFractionDigits:2})}`;
            document.getElementById('totalComView').innerText = `${curr} ${sumCom.toLocaleString('en-US', {minimumFractionDigits:2})}`;
        }

        document.getElementById('formTrain').addEventListener('submit', (e) => {
            addRow(e, 'formTrain', qbrData.treinamentos, {
                course: document.getElementById('trainName').value, person: document.getElementById('trainPerson').value,
                date: document.getElementById('trainDate').value, status: document.getElementById('trainStatus').value
            }, renderTrain);
        });
        function renderTrain() {
            const tbody = document.getElementById('tableTrain'); tbody.innerHTML = '';
            qbrData.treinamentos.forEach((item, index) => {
                let statusColor = item.status === 'Concluido' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                tbody.innerHTML += `<tr class="border-b"><td class="py-2 font-medium">${item.course}</td><td class="py-2">${item.person}</td><td class="py-2">${item.date}</td><td class="py-2"><span class="${statusColor} px-2 py-1 rounded text-xs">${item.status}</span></td><td class="py-2"><button onclick="removeRow(${index}, qbrData.treinamentos, renderTrain)" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- MOTOR DE EXPORTA√á√ÉO ---
        function exportAllToCSV() {
            const partner = document.getElementById('partnerInput').value || 'Parceiro';
            const date = document.getElementById('qbrDate').value || new Date().toISOString().split('T')[0];
            const amName = document.getElementById('amInput').value || '';
            
            let csvContent = "data:text/csv;charset=utf-8,";
            // Cabe√ßalho Mestre Padronizado
            csvContent += `NEXTSTREAM MASTER QBR\nParceiro:,${partner}\nData:,${date}\nAccountManager:,${amName}\n\n`;

            csvContent += "1. OBJETIVOS ESTRATEGICOS\nObjetivo,Prazo,Responsavel,Observacoes\n";
            qbrData.objetivos.forEach(o => { csvContent += `"${o.desc}","${o.date}","${o.owner}","${o.obs}"\n`; });
            csvContent += "\n";

            csvContent += "2. CLIENTES TARGET\nCliente,Acao Mapeada,Status,Observacoes\n";
            qbrData.targets.forEach(t => { csvContent += `"${t.client}","${t.action}","${t.status}","${t.obs}"\n`; });
            csvContent += "\n";

            csvContent += "3. PIPELINE DE COLOCATION E SERVICOS\nCliente,Data Centers,Contrato(M),Racks,kVA/Rack,kVA Total,Setup,Moving,SmartHands(Sim/Nao),TCV,Comissao(%)\n";
            qbrData.projetos.forEach(p => { csvContent += `"${p.client}","${p.dcs}",${p.term},${p.racks},${p.kva},${p.totalKva},${p.setup},${p.moving},"${p.smartHands}",${p.tcv},${p.comPerc}\n`; });
            csvContent += "\n";

            csvContent += "4. TREINAMENTOS (NPP)\nCurso,Colaborador,Data,Status\n";
            qbrData.treinamentos.forEach(t => { csvContent += `"${t.course}","${t.person}","${t.date}","${t.status}"\n`; });

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `QBR_${partner.replace(/\s+/g, '_')}_${date}.csv`);
            document.body.appendChild(link);
            link.click(); document.body.removeChild(link);
        }

        // --- MOTOR DE IMPORTA√á√ÉO BIDIRECIONAL (O C√©rebro da Opera√ß√£o) ---
        function importAllFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                complete: function(results) {
                    processImportedData(results.data);
                    // Reseta o input de arquivo para permitir importar o mesmo arquivo novamente se necess√°rio
                    document.getElementById('importCsv').value = '';
                }
            });
        }

        function processImportedData(data) {
            // Limpa dados atuais
            qbrData = { objetivos: [], targets: [], projetos: [], treinamentos: [] };
            let currentSection = 0;

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                // Pula linhas totalmente vazias
                if (!row || row.length === 0 || (row.length === 1 && row[0].trim() === "")) continue;

                const col0 = row[0] ? row[0].trim() : "";

                // Detecta Mudan√ßa de Se√ß√£o no CSV
                if (col0.includes("NEXTSTREAM MASTER QBR")) { currentSection = 0; continue; }
                if (col0.includes("1. OBJETIVOS ESTRATEGICOS")) { currentSection = 1; i++; continue; } // Pula a linha de cabe√ßalho da tabela
                if (col0.includes("2. CLIENTES TARGET")) { currentSection = 2; i++; continue; }
                if (col0.includes("3. PIPELINE DE COLOCATION")) { currentSection = 3; i++; continue; }
                if (col0.includes("4. TREINAMENTOS (NPP)")) { currentSection = 4; i++; continue; }

                // Popula os Dados de Acordo com a Se√ß√£o
                if (currentSection === 0) {
                    if (col0 === "Parceiro:") document.getElementById('partnerInput').value = row[1] || "";
                    if (col0 === "Data:") document.getElementById('qbrDate').value = row[1] || "";
                    if (col0 === "AccountManager:") document.getElementById('amInput').value = row[1] || "";
                } 
                else if (currentSection === 1) {
                    qbrData.objetivos.push({ desc: col0, date: row[1] || "", owner: row[2] || "", obs: row[3] || "" });
                } 
                else if (currentSection === 2) {
                    qbrData.targets.push({ client: col0, action: row[1] || "", status: row[2] || "", obs: row[3] || "" });
                } 
                else if (currentSection === 3) {
                    // Mapeamento: Cliente[0], DCs[1], Term[2], Racks[3], kVA/Rack[4], TotalKVA[5], Setup[6], Moving[7], SH[8], TCV[9], Com%[10]
                    const term = parseInt(row[2]) || 24;
                    const racks = parseInt(row[3]) || 1;
                    const kva = parseFloat(row[4]) || 0;
                    const tcv = parseFloat(row[9]) || 0;
                    const comPerc = parseFloat(row[10]) || 0;
                    
                    qbrData.projetos.push({
                        client: col0, dcs: row[1] || "", term: term, racks: racks, kva: kva,
                        totalKva: parseFloat(row[5]) || 0, setup: parseFloat(row[6]) || 0, moving: parseFloat(row[7]) || 0,
                        smartHands: row[8] || "N√£o", tcv: tcv, comPerc: comPerc, comValor: tcv * (comPerc / 100)
                    });
                } 
                else if (currentSection === 4) {
                    qbrData.treinamentos.push({ course: col0, person: row[1] || "", date: row[2] || "", status: row[3] || "" });
                }
            }

            // Re-renderiza tudo com os novos dados
            renderObj();
            renderTarget();
            renderProject();
            renderTrain();
            alert("‚úÖ Dados importados com sucesso! O dashboard foi atualizado.");
        }
    </script>
</body>
</html>
