<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NextStream - QBR & Joint Strategy Dashboard 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-100 font-sans text-slate-800 pb-12">

    <header class="bg-slate-900 text-white p-6 shadow-md border-b-4 border-green-500 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">NextStream | <span class="text-blue-400 font-normal">Channel Strategy & QBR</span></h1>
                <p class="text-sm text-slate-400 mt-1">Integração de Receita: Colocation & Serviços Acoplados</p>
            </div>
            <div class="flex space-x-4">
                <button onclick="exportAllToCSV()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded text-sm font-bold shadow transition">
                    <i class="fas fa-file-export mr-2"></i>Exportar QBR (CSV)
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 mt-4 space-y-6">

        <section class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 border-l-4 border-l-orange-500">
            <h2 class="text-lg font-bold text-slate-800 mb-2"><i class="fas fa-server text-orange-500 mr-2"></i>Pipeline Avançado (Colocation + Serviços)</h2>
            <p class="text-sm text-slate-500 mb-6">Calculadora baseada em R$ 1.100/kVA. Comissão variável por tempo de contrato (24m: 5% | 36m: 7% | 48m: 8.5% | 60m: 10%).</p>
            
            <form id="formProject" class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-4 bg-slate-50 p-4 rounded-lg border border-slate-200">
                
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-xs font-semibold text-slate-600 mb-1">Cliente Final</label>
                    <input type="text" id="projClient" required class="w-full rounded border-slate-300 p-2 border text-sm" placeholder="Nome da Conta">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-1">Tempo de Contrato</label>
                    <select id="projTerm" required class="w-full rounded border-slate-300 p-2 border text-sm font-bold text-blue-700">
                        <option value="24">24 Meses (5% Com.)</option>
                        <option value="36">36 Meses (7% Com.)</option>
                        <option value="48">48 Meses (8.5% Com.)</option>
                        <option value="60">60 Meses (10% Com.)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-1">Racks</label>
                    <input type="number" id="projRacks" required min="1" class="w-full rounded border-slate-300 p-2 border text-sm" value="1">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-1">kVA por Rack</label>
                    <input type="number" id="projKva" required min="1" step="0.5" class="w-full rounded border-slate-300 p-2 border text-sm" placeholder="Ex: 5">
                </div>

                <div class="col-span-1 md:col-span-4 grid grid-cols-3 gap-3 border-t border-slate-200 pt-3 mt-1">
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Setup (Total R$)</label>
                        <input type="number" id="projSetup" class="w-full rounded border-slate-300 p-2 border text-sm" placeholder="Padrão R$ 25k/rack">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Moving (Total R$)</label>
                        <input type="number" id="projMoving" class="w-full rounded border-slate-300 p-2 border text-sm" placeholder="Custo de Migração">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-600 mb-1">Smart Hands (R$/mês)</label>
                        <input type="number" id="projSmartHands" class="w-full rounded border-slate-300 p-2 border text-sm" placeholder="Recorrência">
                    </div>
                </div>
                
                <div class="col-span-1 border-t border-slate-200 pt-3 mt-1 flex items-end">
                    <button type="submit" class="w-full bg-slate-900 text-white font-bold px-4 py-2 rounded hover:bg-slate-800 transition shadow-sm">
                        <i class="fas fa-plus mr-1"></i> Add
                    </button>
                </div>
            </form>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th class="p-3">Cliente</th>
                            <th class="p-3 text-center">Contrato</th>
                            <th class="p-3 text-center">Space/Power</th>
                            <th class="p-3 text-right">Serviços Adic. (R$)</th>
                            <th class="p-3 text-right text-blue-700">TCV (R$)</th>
                            <th class="p-3 text-right text-green-700">Comissão Projetada</th>
                            <th class="p-3 text-center">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="tableProject"></tbody>
                </table>
            </div>
            
            <div class="mt-4 p-4 bg-slate-50 border border-slate-200 rounded-lg flex justify-end space-x-8">
                <div class="text-right">
                    <p class="text-xs font-bold text-slate-500 uppercase">TCV Total Pipeline</p>
                    <p id="totalTcvView" class="text-2xl font-black text-slate-800">R$ 0.00</p>
                </div>
                <div class="text-right">
                    <p class="text-xs font-bold text-slate-500 uppercase">Comissões Potenciais</p>
                    <p id="totalComView" class="text-2xl font-black text-green-600">R$ 0.00</p>
                </div>
            </div>
        </section>

    </main>

    <script>
        const projetos = [];
        const VALOR_KVA = 1100; // Referência da matriz de preços NextStream

        document.getElementById('formProject').addEventListener('submit', (e) => {
            e.preventDefault();

            const racks = parseInt(document.getElementById('projRacks').value) || 0;
            const kva = parseFloat(document.getElementById('projKva').value) || 0;
            const term = parseInt(document.getElementById('projTerm').value);
            
            // Valores de Serviços (Se vazio, assume 0. Setup default para agilizar, mas pode ser sobrescrito)
            const inputSetup = document.getElementById('projSetup').value;
            const setupTotal = inputSetup !== "" ? parseFloat(inputSetup) : (racks * 25000); // R$ 25k sugerido por rack
            const movingTotal = parseFloat(document.getElementById('projMoving').value) || 0;
            const smartHandsMensal = parseFloat(document.getElementById('projSmartHands').value) || 0;

            // Cálculos
            const potenciaTotal = racks * kva;
            const mrrColocation = potenciaTotal * VALOR_KVA;
            const mrrTotal = mrrColocation + smartHandsMensal;
            
            const tcv = (mrrTotal * term) + setupTotal + movingTotal;

            // Lógica de Comissão NextStream
            let comissaoPerc = 0;
            if (term === 24) comissaoPerc = 0.05;
            if (term === 36) comissaoPerc = 0.07;
            if (term === 48) comissaoPerc = 0.085;
            if (term >= 60) comissaoPerc = 0.10;

            // Parceiro ganha comissão sobre o TCV (podemos isolar Setup depois se a regra da Actis exigir)
            const comissaoValor = tcv * comissaoPerc;

            const obj = {
                client: document.getElementById('projClient').value,
                term: term, racks: racks, kva: kva, totalKva: potenciaTotal,
                setup: setupTotal, moving: movingTotal, smartHands: smartHandsMensal,
                tcv: tcv, comPerc: comissaoPerc * 100, comValor: comissaoValor
            };
            
            projetos.push(obj);
            
            // Reseta form inteligente
            document.getElementById('projClient').value = '';
            document.getElementById('projSetup').value = '';
            document.getElementById('projMoving').value = '';
            document.getElementById('projSmartHands').value = '';
            
            renderProject();
        });

        function renderProject() {
            const tbody = document.getElementById('tableProject');
            tbody.innerHTML = '';
            
            let sumTcv = 0;
            let sumCom = 0;

            projetos.forEach((item, index) => {
                sumTcv += item.tcv;
                sumCom += item.comValor;

                const servicosExtrasHtml = `Setup: R$ ${item.setup.toLocaleString('pt-BR')} <br> Mov: R$ ${item.moving.toLocaleString('pt-BR')} <br> SH: R$ ${item.smartHands.toLocaleString('pt-BR')}/m`;
                
                tbody.innerHTML += `<tr class="border-b hover:bg-white transition">
                    <td class="p-3 font-bold">${item.client}</td>
                    <td class="p-3 text-center"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">${item.term} Meses</span></td>
                    <td class="p-3 text-center text-xs text-slate-500">${item.racks} Racks <br> <span class="font-bold text-orange-600">${item.totalKva} kVA Total</span></td>
                    <td class="p-3 text-right text-xs text-slate-500">${servicosExtrasHtml}</td>
                    <td class="p-3 text-right font-black text-slate-800">R$ ${item.tcv.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="p-3 text-right"><span class="block font-black text-green-600">R$ ${item.comValor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span><span class="text-xs text-slate-400">(${item.comPerc}% Ref.)</span></td>
                    <td class="p-3 text-center"><button onclick="removeRow(${index})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });

            document.getElementById('totalTcvView').innerText = `R$ ${sumTcv.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('totalComView').innerText = `R$ ${sumCom.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        function removeRow(index) {
            projetos.splice(index, 1);
            renderProject();
        }

        function exportAllToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Cliente,Contrato (Meses),Racks,kVA Total,Setup(R$),Moving(R$),SmartHands(R$/mes),TCV(R$),Comissao(%)\n";
            projetos.forEach(p => { 
                csvContent += `"${p.client}",${p.term},${p.racks},${p.totalKva},${p.setup},${p.moving},${p.smartHands},${p.tcv},${p.comPerc}\n`; 
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", `NextStream_Pipeline_Servicos.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
